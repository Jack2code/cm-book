# 设备大包设备补丁澄清文档

标签（空格分隔）： NaaS-Controller

---
[TOC]

设备软件，指设备大包及设备补丁。

## 澄清内容
1、	首先，选择需要进行升级的设备组，可以选择多个设备组，若选择了多个设备组，则所选择的设备组都会加载同一个设备大包或设备补丁；
2、	然后，选择系统文件或补丁（两者可二选一，也可以两者均选），Web UI需要对文件的版本与设备组当前版本进行比较，并给出提示；
1）	若仅升级系统文件（设备软件大包），则Web UI提示用户设备组的软件大包版本将升级到**版本；
2）	若仅加载补丁文件，则该补丁将当前设备组的软件大包中加载，Web UI需要检查补丁文件的配套版本是否与设备组当前版本一致，如果一致，则提示用户补丁版本将在设备组当前**版本中加载；否则，提示用户补丁版本与设备组当前版本不一致，无法加载补丁；
3）	若同时加载软件大包文件和补丁文件，先判断设备组当前版本与补丁版本是否匹配，软件大包版本与补丁版本是否匹配，若补丁版本与当前设备组、待加载的软件大包版本都匹配，那么先在当前设备组加载补丁，然后加载软件大包，再加载补丁。若补丁版本与当前设备组版本不匹配而与待加载软件大包版本匹配，则先加载软件大包，再加载补丁。若补丁版本与当前设备组版本匹配而与待加载软件大包版本不匹配，则先加载补丁，再加载软件大包。若补丁版本与设备组当前版本、待加载软件大包版本都不一致，则提示用户版本不匹配错误。
3、	点击页面上的“升级”按钮，后台获取设备组中所有的在线设备，调用南向接口，向设备下发加载文件命令，然后以1分钟（未确定具体时间？）为时间间隔去设备查询文件加载进度，得到每个设备的返回进度结果后，以设备组为单位进行加权计算设备组加载文件的整体进度，并返回给Web UI进行进度条呈现。加载文件成功后，向MongoDB数据库中插入文件实体数据。
4、	对于离线设备，监听设备上线消息。设备上线后，调用南向接口，获取设备已加载的文件信息，与数据库中设备组当前配置的文件信息进行对比，以设备组当前配置为标准进行离线设备的文件同步。若离线设备当前的软件大包版本与设备组版本不一致，则将设备当前版本升级到设备组版本，加载设备组的软件大包和补丁（如果当前设备组有补丁）。
5、	设备组升级，若设备组中的部分设备出现大包升级失败的情况（例如设备多次注册失败，无法与Controller建立连接），则该设备依然属于当前设备组，但会提示类似“部分节点不支持”的提示信息。
6、	设备更换设备组，根据新设备组的配置进行配置，加载新设备组的软件大包和补丁。



## 讨论要点
1. 由于设备软件大包格式有差异，controller解析包名得到版本号，也可以手动输入版本号；
2. 手动输入版本号需要确保格式是正确的，在界面提示用户正确的格式；
3. 设备软件大包升级导致设备版本变化，也会导致设备配置模型变化；
4. 软件大包升级导致设备组兼容性问题
1）软件大包升级以后，是否会导致设备版本变化？ 
2）软件大包升级以后，是否会导致配置模型变化？
如果上面两个问题都肯定答复。那么，当前的设备组会绑定版本，升级以后，有可能导致原来的设备组不包含这个组。所以，升级过程有可能会导致设备组的拆分。
现在设备组计划按照下面方案实施：
1）设备组进行大包升级 
2）设备升级，重启，重连控制器 
3）Controller查询设备版本
4）Controller发现由于升级导致版本变化，新建设备组，分析继承原有配置（针对不支持配置需要删除）。
其中4）比较复杂，特别设计版本变化导致模型变化比对。也请大家发表下意见。

    **结论**：
    当设备组升级以后，仍然还是一个设备组，按照升级以后的模型进行业务解释配置。如果出现部分设备软件大包升级失败情况下（比如：3.3的情况）， 还是按照原来逻辑，会重新下发设备的配置信息，这时按照升级后的模型下发，设备提示类似“部分节点不支持”的提示信息。

5. 软件大包与补丁是否可以同时升级？
当前设计页面，系统文件与补丁可以同时选择。而现在接口都是同一个rpc load-file。那这个顺序如何确定？比如：是否会存在后面两种情况：
1）先加载补丁，然后在加载软件大包？ 
2）先加载软件大包，再加载补丁？
还是这种情况Controller可以不用考虑，直接在list files填入即可？有没有必要分开来？或者指定顺序？
    **结论**：
1）	分开两个页面进行软件大包和补丁升级，只支持一次一个补丁，一次一个软件大包来操作。请福星刷新低保真。
2）	上传补丁时，设备解析出补丁中的包头中的版本号，用户可在描述中由用户手工输入描述信息。在打补丁时，根据设备组的软件大包版本适合的软件补丁出来。解释不出包头，加载失败。

6. 当前文件加载是通过RPC实现的，是无法实现离线配置的功能。那同一个组里面存在不在线设备的情况，如何处理？
**结论**：
1）为了解决离线配置问题，设备组已经配置了软件大包加载，设备往controller注册时，controller判断设备软件版本与软件大包包头包含版本号不一致，需要重新下发加载软件大包的命令。设备需要保证软件大包中的版本与通过netconf查询版本规则完全一致。解释不出包头，加载失败。
2）杨坚锐提供如何从cc大包中获取软件补丁的逻辑和代码。 
3）设备往控制器注册时，连续发生2次（达到）由于未知原因无法正确加载新大包时，第3次接受设备注册，但是不再推送大包加载的配置到设备，controller的计数清零。如果这是管理员希望设备强制升级，下发设备强制重启（界面增加一个设备重启功能）。这种情况会导致第一个问题中，期间无法修改设备注册。
4）软件补丁的离线配置参见上一条。设备必须保证最新软件补丁必须包含此版本的历史补丁，否则有可能出现补丁安装失败情况。
5）连续加载时，设备自行判断是否重新下载包。

---
1. 获取所有设备组，包括设备组名称、当前版本、补丁版本；
2. 获取所有设备软件大包，包括文件名、版本、大小；
3. 获取所有设备补丁，包括升级与补丁文件、配套版本、大小；
4. 设备组是否支持所选设备大包接口；
5. 设备软件大包与设备补丁是否匹配接口；
6. 设备组是否支持所选设备补丁接口；





